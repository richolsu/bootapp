<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
 
<body>
  <div class="container" layout:fragment="content">
    <ul class="breadcrumb">
      <li>
        <a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a>
      </li>
      <li><a th:href="@{/notice}">公告通知</a></li>
      <li class="active" th:text="${#strings.contains(#request.requestURI,'add')} ?'新建公告通知':'公告通知详细'"></li>
    </ul>
    <div class="btn-group-bar">
      <div class="text-right">
        <a class="btn btn-primary" sec:authorize="hasRole('ROLE_BUYER') or hasRole('ROLE_ADMIN')" th:if="${notice.createAccount?.id==session.account_id and (notice.state==1  || notice.state==4)}" id="save"><i class="fa fa-save"></i> 保存</a>
        <a class="btn btn-primary" sec:authorize="hasRole('ROLE_BUYER') or hasRole('ROLE_ADMIN')" th:if="${notice.createAccount?.id==session.account_id and (notice.state==1  || notice.state==4)}" id="submit"><i class="fa fa-share"></i> 提交</a>
        <a class="btn btn-primary" sec:authorize="hasRole('ROLE_BUYER') or hasRole('ROLE_ADMIN')" th:if="${notice.createAccount?.id==session.account_id and notice.id !=null and (notice.state==1  || notice.state==4)}" id="delete"><i class="fa fa-remove"></i> 删除</a>
        <a class="btn btn-primary" sec:authorize="hasAuthority('公告通知-发布')" th:if="${notice.state==2}" id="verify"><i class="fa fa-check-square"></i> 发布</a>
        <a class="btn btn-primary" sec:authorize="hasAuthority('公告通知-发布')" th:if="${notice.state==2}" id="cancel"><i class="fa fa-undo"></i> 退回</a>
        <a class="btn btn-default" th:href="@{/notice}"><i class="fa fa-arrow-left"></i> 返回</a>
      </div>
    </div>
    
    
    <form id="form" th:action="@{/notice/update}" method="post" enctype="multipart/form-data">  
    <input type="hidden" id="id" name="id" th:value="${notice.id}">
    <div class="panel panel-default">
      <div class="panel-body form-body"> 
        <div class="row">
          <div class="col-lg-10 col-md-10 form-group">
            <label for="title">标题: </label>
            <input type="text" name="title" id="title" class="form-control" th:value="${notice.title}">
          </div>
          <div class="col-lg-2 col-md-2 form-group">
            <label for="title">状态: </label>
            <select type="text" id="state" name="state" class="form-control" readonly></select>
          </div>                    
          
          <div class="col-lg-12 col-md-12 form-group">
            <label for="content">内容: </label>
            <textarea name="content" id="content" class="form-control" rows=5 th:text="${notice.content}"></textarea>
          </div>

          <div class="col-lg-8 col-md-8 form-group" id="file_select" th:if="${(notice.state==1 or notice.state == 4) and notice.attachFileName == null}">
            <div class="input-group input-file" name="attach">
              <span class="input-group-btn">
                <button class="btn btn-success btn-file btn-choose" type="button">选择附件</button>
              </span>
              <input type="text" class="form-control" placeholder='请选择附件' />
              <span class="input-group-btn">
                 <button class="btn btn-warning btn-file btn-reset" type="button">重置</button>
              </span>
            </div>
          </div>
          <div class="col-lg-8 col-md-8 form-group" id="file_show" th:if="!${(notice.state==1 or notice.state == 4) and notice.attachFileName == null}">
            <div>
              <a th:href="@{|/uploads/notice/${notice.attachFileName}|}" th:if="${notice.attachFileName}" th:text="${notice.attachOriginalName}"></a>
              <span th:if="!${notice.attachFileName}"><b>附件：</b>---</span>              
              <a class="btn btn-danger" id="del_attach" th:if="${notice.createAccount?.id==session.account_id and (notice.state==1  || notice.state==4)}">删除附件</a>
            </div>
          </div>
          <div class="col-lg-2 col-md-2 form-group">
            <div class="ui toggle checkbox">
              <input type="checkbox" name="to_all_vendor" id="to_all_vendor" value="1" th:checked="${notice.toAllVendor}">
              <label>全部供应商</label>
            </div>
          </div>
          <div class="col-lg-2 col-md-2 form-group">
            <div class="ui toggle checkbox">
              <input type="checkbox" name="to_unit_account" value="1" th:checked="${notice.toUnitAccount}">
              <label>内部人员</label>
            </div>
          </div>
          <div class="col-lg-12 col-md-12 form-group" id="vendor_div">
            <label for="vendor_list">供应商列表: </label>
            <textarea id="vendor_list" rows="5" name="vendor_list" th:text="${vendorList}" class="form-control"></textarea>
          </div>
          <div class="col-lg-3 col-md-3 form-group">
            <label for="title">创建人: </label>
            <input type="text" class="form-control" readonly th:value="${notice.createAccount?.realname}">
          </div>
          <div class="col-lg-3 col-md-3 form-group">
            <label for="title">创建时间: </label>
            <input type="text" class="form-control" readonly th:value="${#dates.format(notice.createDate, 'yyyy-MM-dd HH:mm:ss')}">
          </div>                    
          <div class="col-lg-3 col-md-3 form-group">
            <label for="title">发布人: </label>
            <input type="text" class="form-control" readonly th:value="${notice.verifyAccount?.realname}">
          </div>
          <div class="col-lg-3 col-md-3 form-group">
            <label for="title">发布时间: </label>
            <input type="text" class="form-control" readonly th:value="${#dates.format(notice.verifyDate, 'yyyy-MM-dd HH:mm:ss')}">
          </div> 
        </div>
      </div>
    </div>
    </form>
    
    </div>
</body>
</html>
<script th:inline="javascript" sec:authorize="hasRole('ROLE_VENDOR')">
is_vendor = 1;
</script>

<script th:inline="javascript">
var edit_url = /*[[@{/notice/}]]*/'';
var state = /*[[${notice.state}]]*/'';
var account_url = /*[[@{/vendor/select/}]]*/'';

/*[+
var isEditable = [[${notice.createAccount?.id==session.account_id and (notice.state==1  || notice.state==4)}?true:false]];
var hasAttach = [[${notice.attachFileName != null}]];
var is_to_all_vendor = [[${notice.toAllVendor}?true:false]];
+]*/ 

jQuery(document).ready(function() {   

  App.bs_input_file();
  $("#state").select2({ data: App.getNoticeStateData(),minimumResultsForSearch: -1}).select2("val", state.toString());
  
  if (!isEditable){
    $('#title').attr("readonly", true);
    $("#content").attr("readonly", true);
    $("input:checkbox").attr("disabled", true);
    
  }else{
    if (hasAttach){
      $('#file_select').hide();
      $('#file_show').show();
    }else{
      $('#file_select').show();
      $('#file_show').hide();
    }
  }
  
  if (is_to_all_vendor)
    $("#vendor_div").hide();
  else
    $("#vendor_div").show();
  
  var is_add = $("#id").val().length==0;
  $("#form" ).validate({
    // define validation rules
    rules: {
        title: {
            required: true
        }, 
        content: {
            required: true
        },
    },
    
    //display error alert on form submit  
    invalidHandler: function(event, validator) {
      App.showErrorDialog("输入有误", "请输入正确的值");
    },

    submitHandler: function (form) {
        jQuery(form).ajaxSubmit({
            success: function(res, status, xhr, form) {
              App.showSuccessDialog("操作成功", function(){
                  window.location.href = edit_url + res.id + "/edit";
              });
            },
            error: function (res, status, xhr, form) {
              App.showErrorDialog("操作失败", "请输入正确的值");
            }
        });
    }
  }); 
  
  $("#to_all_vendor").change(function(){  //"select all" change 
    if($(this).prop("checked")){
      $( "#vendor_div" ).hide();
    }else{
      $( "#vendor_div" ).show();
    }    
  });
  
  $( "#vendor_list" ).on( "keydown", function( event ) {
    if ( event.keyCode === $.ui.keyCode.TAB &&
        $( this ).autocomplete( "instance" ).menu.active ) {
      event.preventDefault();
    }
  }).autocomplete({
    source: function( request, response ) {
      $.ajax({
        url: account_url + "?q=" + extractLast( request.term ),
        dataType: "json",
        success: function( data ) {
          var result =$.map(data.content, function (item) {
              return {
                  label: item.title + '(' + item.id + ')',
                  value: item.title + '(' + item.id + ')'
              };
          });
          response(result);
          
        }
      });
    },
    search: function() {
      // custom minLength
      var term = extractLast( this.value );
      if ( term.length < 1 ) {
        return false;
      }
    },
    focus: function() {
      // prevent value inserted on focus
      return false;
    },
    select: function( event, ui ) {
      var terms = split( this.value );
      // remove the current input
      terms.pop();
      // add the selected item
      terms.push( ui.item.value );
      // add placeholder to get the comma-and-space at the end
      terms.push( "" );
      this.value = terms.join( ", " );
      return false;
    }
  });
  
  $("#save").click(function() {
    $('#state').val(1);
    $("#form").submit();            
  });
  
  $("#submit").click(function() {
    $('#state').val(2);
    $("#form").submit();            
  });
  
  $("#verify").click(function() {
    $('#state').val(3);
    $("#form").submit();            
  });

  $("#cancel").click(function() {
    $('#state').val(4);
    $("#form").submit();            
  });
  
  
  $("#delete").click(function(){
    App.showConfirmDialog('确定要删除吗?', function(){
      var del_url = edit_url + $("#id").val() + "/delete";  
      $.get(del_url, function(data, status){
        App.showSuccessDialog("操作成功", function() {
          window.location.href = edit_url;
        });
      });
    });
  });

  $("#del_attach").click(function(){
    App.showConfirmDialog('确定要删除吗?', function(){
      var del_url = edit_url + $("#id").val() + "/deleteattach";  
      $.get(del_url, function(data, status){
        App.showSuccessDialog("操作成功", function() {
          window.location.reload(true);
        });
      });
    });
  });

});


</script>

