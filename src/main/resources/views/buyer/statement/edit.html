<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
<body>
  <div class="container" layout:fragment="content">
    <ul class="breadcrumb">
      <li>
        <a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a>
      </li>
      <li><a th:href="@{/buyer/statement}" class="active">对账单管理</a></li>
      <li class="active">对账单详细</li>
    </ul>       
    <div class="btn-group-bar">
        <div class="text-right">
          <a class="btn btn-primary" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/buyer') and (main.state==1  or main.state==4)}" id="save"><i class="fa fa-save"></i> 保存</a>
          <a class="btn btn-primary" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/buyer') and (main.state==1  or main.state==4)}" id="submit"><i class="fa fa-share"></i> 发布</a>
          <a class="btn btn-primary" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/vendor') and main.state==2}" id="verify"><i class="fa fa-check-square"></i> 确认</a>
          <a class="btn btn-primary" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/vendor') and main.state==2}" id="cancel"><i class="fa fa-undo"></i> 退回</a>
          <a class="btn btn-primary" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/vendor') and main.state==3}" id="invoice"><i class="fa fa-check-square"></i> 填发票号</a>
          <a class="btn btn-default" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/buyer')}" th:href="@{/buyer/statement}"><i class="fa fa-arrow-left"></i> 返回</a>
          <a class="btn btn-default" th:if="${#strings.startsWith(#httpServletRequest.requestURI,'/vendor')}" th:href="@{/vendor/statement}"><i class="fa fa-arrow-left"></i> 返回</a>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-body"> 
        <form id="form" th:action="@{'/' + ${#strings.startsWith(#httpServletRequest.requestURI,'/vendor')?'vendor':'buyer'} + '/statement/update'}" method="post">
            <div class="row">
                <div class="col-lg-3 col-md-3">
                  <label for="code">单号: </label>
                  <input type="text" id="code" name="code" th:value="${main.code}" class="form-control" readonly />
                </div>
                <div class="col-lg-3 col-md-3">
                  <label for="vendor">供应商:</label>
                  <select id="vendor" name="vendor" class="form-control">
                    <option th:if="${main.vendor != null}" th:value="${main.vendor?.code}" th:text="${main.vendor?.name}" selected="selected">NEC（日电）有限公司</option>
                  </select>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label for="address">供应商地址: </label>
                  <input type="text" id="address" th:value="${main.vendor?.address}" class="form-control" readonly>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label for="state">状态:</label>
                  <select name="state" id="state" class="form-control" readonly>
                  </select>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label for="maker">制单人:</label>
                  <select name="maker" id="maker" class="form-control select2" readonly>
                    <option th:value="${main.maker?.id}" th:text="${main.maker?.realname}" selected="selected"></option>
                  </select>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label for="makedate">单据日期: </label>
                  <input type="text" name="makedate" id="makedate" th:value="${#dates.format(main.makedate, 'yyyy-MM-dd')}" class="form-control" readonly>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label>审核人:</label>
                  <select class="form-control select2" readonly>
                    <option th:value="${main.verifier?.id}" th:text="${main.verifier?.realname}" selected="selected"></option>
                  </select>
                </div>
                <div class="col-lg-3 col-md-3">
                  <label>审核日期: </label>
                  <input type="text" th:value="${#dates.format(main.verifydate, 'yyyy-MM-dd')}" class="form-control" readonly>
                </div>
                <div class="col-lg-6 col-md-6">
                  <label for="remark">订单摘要: </label>
                  <input type="text" id="remark" name="remark" th:value="${main.remark}" class="form-control" />
                </div>                
                <div class="col-lg-6 col-md-6">
                  <label for="invoice_code">发票号: </label>
                  <input type="text" id="invoice_code" name="invoice_code" th:value="${main.invoiceCode}" class="form-control" readonly/>
                </div>                

            </div>
            <div class="row margin-top-10">
              <div class="col-lg-12">
                <div class="margin-bottom-30">
                  <div class="tab-style-1" id="tabs">
                    <ul class="nav nav-tabs">
                      <li class="active"><a data-toggle="tab" href="#tab-1">基本对账</a></li>
                      <li><a data-toggle="tab" class="hidden" href="#tab-2">辅助对账</a></li>
                      <li><a data-toggle="tab" class="hidden" href="#tab-3">出入库单据</a></li>
                    </ul>
                    <div class="tab-content">
                      <div id="tab-1" class="tab-pane row-fluid fade in active">
                        <table id="basic_info" class="table table-striped table-bordered nowrap table-hover" style="width:100%">
                        </table>
                      </div>
                      <div id="tab-2" class="tab-pane row-fluid fade in">
                        <table id="special_info" class="table table-striped table-bordered nowrap table-hover" style="width:100%">
                        </table>
                      </div>
                      <div id="tab-3" class="tab-pane row-fluid fade in">
                        <table id="outside_info" class="table table-striped table-bordered nowrap table-hover" style="width:100%">
                        </table>
                      </div>
                    </div>
                  </div>
                </div>     
              </div>
            </div>
        </form>
        <div class="modal fade" id="import_dialog" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document" style="width:1000px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">
                                                        选择要对账的商品
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        </button>
                    </div>
                    <div class="modal-body form-horizontal">

                      <div class="search-content">
                          <div class="search-cell width-10">
                            <label for="search_date">入库日期: </label>
                            <input type="text" id="search_date" value="" class="form-control" />
                          </div>
                          <div class="search-cell width-10">
                            <label for="search_code">出入库单号：</label>
                            <input type="text" id="search_code" class="form-control">
                          </div>
                          <div class="search-cell width-10">
                            <label for="search_inventory">商品编码/名称：</label>
                            <input type="text" id="search_inventory" class="form-control">
                          </div>
                          <div style="vertical-align: bottom" class="search-cell width-15">
                            <button class="btn btn-default" id="btn_search"><i class="fa fa-search"></i> 查询</button>
                          </div>
                      </div>
                
                      <div class="row">
                        <div class="col-lg-12 table-responsive">
                            <table id="import_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width:100%">
                            </table>
                        </div>
                      </div>  
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="btn_import">保存</button>
                    </div>
                </div>
            </div>
        </div> 
    </div>
    </div>
  </div>
  </div>
</body>
</html>
<script th:inline="javascript">
var editor;
/*[+

var is_vendor = [[${#strings.startsWith(#httpServletRequest.requestURI,'/vendor')?true:false}]];  
var detail_url = [[@{'/' + ${#strings.startsWith(#httpServletRequest.requestURI,'/vendor')?'vendor':'buyer'} + '/statement/'}]] + [[${main.code}]] + "/details";
var edit_url = [[@{'/' + ${#strings.startsWith(#httpServletRequest.requestURI,'/vendor')?'vendor':'buyer'} + '/statement/'}]];
var import_url = [[@{/buyer/purchasein/select}]];
var vendor_search_url = [[@{/api/vendor/select}]];
var state = [[${main.state}]];

+]*/ 
  
$(document).ready(function() {

  var basic_table, prepay_table, outside_table, import_table;
      
  function load_prepay_table() {
    if (prepay_table != undefined)
        return;
        
//    prepay_table = $('#special_info').DataTable(table_options);
    
  }
  
  function load_outside_table() {
      if (outside_table != undefined)
          return;
          
  //    outside_table = $('#outside_info').DataTable(table_options);
      
  }
  
  $('.modal').on('shown.bs.modal', function () {
    load_import_table();
  });
  
  function load_import_table() {
    
    $('#search_code').val('');
    $('#search_date').val('');
    $('#search_inventory').val('');
    
    
    if (import_table == undefined) {

      import_table = $('#import_table').DataTable({
        ordering : true,
        select: true,
        ajax : {
          url : import_url,
          data : function(data) {
            var filter = {
              order : data.columns[data.order[0].column].data,
              dir : data.order[0].dir,
              rows_per_page : data.length,
              page_index : data.start / data.length + 1,
              vendor : $('#vendor').val(),
              inventory: $('#search_inventory').val(),
              code : $('#search_code').val(),
              date : $('#search_date').val()
            }
            return filter;
          },
          dataSrc : function(json) {
            json.recordsTotal = json.totalElements;
            json.recordsFiltered = json.totalElements;
            return json.content;
          },
        },
        columns : [ {
          data : 'date',
          render : $.fn.date_renderer,
          title : '入库日期'
        }, {
          data : 'code',
          title : '出入库单号'
        }, {
          data : 'rowno',
          title : '行号',
        }, {
          data : 'inventoryname',
          title : '商品名称'
        }, {
          data : 'inventorycode',
          title : '商品编码'
        }, {
          data : 'specs',
          title : '规格型号',
        }, {
          data : 'cmassunitname',
          title : '主计量单位',
        }, {
          data : 'price',
          title : '入库单单价',
        }, {
          data : 'quantity',
          title : '入库数量',
        }, {
          data : 'closed_quantity',
          title : '已对账数量',
        }, {
          data : 'cost',
          title : '金额',
        }, {
          data : 'number',
          title : '件数',
/*
        }, {
          data : 'state',
          title : '状态',
          createdCell: App.getInqueryStateClass,
          render : App.getPurchaseInStateOfId        
*/
        } ],
        order: [  [ 1, "asc" ] ]

        
      });
    }
        
    $('#btn_search').trigger('click');

  }
  
  
  $('#tabs').tabs({
    activate: function (event, ui) {
        if (ui.newPanel.selector == '#tab-3')
          load_outside_table();
        else if (ui.newPanel.selector == '#tab-2')
          load_prepay_table();
    }
  });
  
  $('#date').datepicker();
    
  $(".select2").select2();
  $("#state").select2({ data: App.getStatementStateData(),minimumResultsForSearch: -1}).select2("val", state.toString());
  $("#vendor").select2(App.getSelect2Options(vendor_search_url));
  
  if (state > 1) {
    $('input').attr("readonly", true);
    $('select').attr("readonly", true);
  }

  if (state == 3 && is_vendor) {
    $('#invoice_code').removeAttr("readonly");
  }
  
  editor = new $.fn.dataTable.Editor( {
    table: "#basic_info",  
    idSrc: "purchase_in_detail_id",
    fields: [ {
      attr: {
        type: "number"
      },
      name: "closed_quantity"            
    },{
      attr: {
        type: "number"
      },
      name: "closed_price"            
    },{
      attr: {
        type: "number"
      },
      name: "closed_money"            
    },{
      attr: {
        type: "number"
      },
      name: "closed_tax_price"            
    },{
      attr: {
        type: "number"
      },
      name: "closed_tax_money"            
    }],
    i18n: {
        remove: {
            button: "删除行",
            title:  "删除行",
            submit: "是",
            confirm: {
                _: "确定要删除%d行数据吗?",
                1: "确定要删除吗?"
            }
        },
    }
  });
    
  
  
  var table_options = {
      serverSide:false,
      processing:false,
      ordering : true,
      select: true,
      buttons: [
          { 
            text: "取出入库单", 
            action: function( e, dt, node, config) {
              
              if ($("#vendor").val() == undefined) {
                $('#vendor').focus();
                App.showErrorDialog("请选择供应商！");
                return false;
              }
              
              $('#import_dialog').modal('show');
              
            } 
          },
          { extend: "remove", editor: editor },
          { 
            text: "增加扣款项", 
            action: function( e, dt, node, config) {
              if ($("#vendor").val() == undefined) {
                $('#vendor').focus();
                App.showErrorDialog("请选择供应商！");
                return false;
              }
              
              var exist_data = basic_table.rows().data().toArray();
              for(i=0; i<exist_data.length; i++) {
                exist_row = exist_data[i];
                if (exist_row.purchase_in_detail_id == 0) {
                  App.showErrorDialog("已存在扣款项！");
                  return;
                }
              }
              
              var new_row = {
                  assitantunitname:null,
                  closed_money:'',
                  closed_price:'',
                  closed_quantity:'',
                  closed_tax_money:'',
                  closed_tax_price:'',
                  cmassunitname:null,
                  cost:null,
                  purchase_in_detail_id:0,
                  inventorycode:null,
                  inventoryname:null,
                  irate:null,
                  number:null,
                  price:null,
                  purchase_in_code:"扣款",
                  purchase_in_date:null,
                  quantity:null,
                  rowno:null,
                  specs:null,
                  state:null,
              };
              basic_table.row.add(new_row).draw();
            } 
          },
      ],
      ajax : {
        url : detail_url,
        dataSrc : function(json) {
          $.each(json, function(key, item){
            item.dstartdate = $.fn.date_renderer(item.dstartdate);
            item.denddate = $.fn.date_renderer(item.denddate);
          });
          return json;
        },
      },
      columns : [ {
        data : 'purchase_in_detail_id',
        title : 'id',
        visible: false,
      }, {
        data : 'purchase_in_code',
        render: function(data, type, row) {
          if (row.purchase_in_detail_id == 0){
            return "扣款项";
          }else{
            return data;
          }
        },
        title : '入库单编码',
      }, {
        data : 'purchase_in_date',
        render : $.fn.date_renderer,
        title : '入库日期',        
      }, {
        data : 'rowno',
        visible:false,
        title : '入库单行号'
      }, {
        data : 'inventoryname',
        title : '商品名称',
      }, {
        data : 'inventorycode',
        title : '商品编码',
      }, {
        data : 'specs',
        visible:false,
        title : '规格型号',
      }, {
        data : 'cmassunitname',
        title : '单位',
      }, {
        data : 'price',
        title : '单价',
      }, {
        data : 'quantity',
        title : '入库数量',
/*        
      }, {
        data : 'assitantunitname',
        title : '辅计量单位'
      }, {
        data : 'irate',
        title : '换算率',
*/        
      }, {
        data : 'cost',
        title : '金额',
      }, {
        data : 'number',
        title : '件数',
      }, {
        data : 'closed_quantity',
        className: 'edit-cell',
        title : '对账数量',
      }, {
        data : 'closed_price',
        className: 'edit-cell',
        title : '结算未税单价',
      }, {
        data : 'closed_money',
        className: 'edit-cell',
        title : '结算未税金额',
      }, {
        data : 'closed_tax_price',
        className: 'edit-cell',
        title : '结算含税单价',
      }, {
        data : 'closed_tax_money',
        className: 'edit-cell',
        title : '结算含税金额',

      } ],
      "columnDefs": [ {
        "targets": [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ],
        "orderable": false
      } ],
      order: [  [ 0, "asc" ], [3, "asc"] ],
    };
  
  if (state>1) {
    table_options.select = false;
    table_options.buttons = [];
  }
  
  basic_table = $('#basic_info').DataTable(table_options);

  if (state == 1) {
    basic_table.on( 'click', 'tbody td.edit-cell', function (e) {
      editor.inline( this, { submit: 'allIfChanged', submitOnBlur: true });
    } );
    App.addKeyDownEditor(editor, 11, 15);
  }

  
  
  $("#form" ).validate({
    // define validation rules
    rules: {
        vendor: {
            required: true
        }, 
        invoice_code: {
          required: state==3
        }, 
    },
    
    //display error alert on form submit  
    invalidHandler: function(event, validator) {
      App.showErrorDialog("操作失败", "请输入正确的值");
      validator.focusInvalid();
    },

    submitHandler: function (form) {
      var data = basic_table.rows().data().toArray();
      var post_data = {};
      if (!is_vendor)
        post_data.table = data;
      
      jQuery(form).ajaxSubmit({
          data: post_data,
          success: function(res, status, xhr, form) {
            App.showSuccessDialog("操作成功", function(){
              window.location.href = edit_url + res.code + "/edit";
            });
          },
          error: function (res, status, xhr, form) {
            App.showErrorDialog("操作失败", "请输入正确的值");
          }
      });
    }
  }); 
  
  $("#btn_search").click(function() {
    import_table.draw();
  });
  
  $('#btn_import').click(function(){
    $('#import_dialog').modal('hide');//modal_1 is the id 1
    var selected_data = import_table.rows('.selected').data().toArray();
    var exist_data = basic_table.rows().data().toArray();
    $.each(selected_data, function(key, item){
      var available = true;
      for(i=0; i<exist_data.length; i++) {
        exist_row = exist_data[i];
        if (exist_row.purchase_in_code == item.code && exist_row.rowno == item.rowno) {
          available = false;
          break;
        }
      }
      if (available) {
        item.purchase_in_detail_id = item.id;
        item.purchase_in_code = item.code;
        item.purchase_in_date = item.date;
        item.closed_money = '';
        item.closed_price = '';
        item.closed_quantity = '';
        item.closed_tax_money = '';
        item.closed_tax_price = '';
        basic_table.row.add(item);  
      }
    })
    
    basic_table.draw();
    
    
  });
  
  $('#vendor, #code, #inventory, #date').keyup(function(e) {
    if (e.keyCode == 13)
      import_table.draw();
  });
  
  $("#save").click(function() {
    $('#state').val(1);
    $("#form").submit();            
  });
  
  $("#submit").click(function() {
    var data = basic_table.rows().data().toArray();
    if (data.length == 0) {
      App.showErrorDialog("操作失败", "没有要发布的商品");
      return;
    }
    $('#state').val(2);
    $("#form").submit();            
  });
  
  $("#verify").click(function() {
    $('#state').val(3);
    $("#form").submit();            
  });   
  
  $("#cancel").click(function() {
    $('#state').val(4);
    $("#form").submit();            
  });
  
  $("#invoice").click(function() {
    $("#form").submit();            
  });   
  
  
});
</script>

