<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<body>
	<div class="container" layout:fragment="content">
		<ul class="breadcrumb">
			<li><a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a></li>
			<li class="active">发货单管理</li>
		</ul>
		<div class="search-content">
			<div class="search-cell width-10 form-group">
				<label for="code"> 发货单号：</label> <input type="text" id="code" class="form-control">
			</div>
			<div class="search-cell width-10 form-group" id="vendor_div">
				<label for="vendor"> 供应商编码/名称：</label> <input type="text" id="vendor" class="form-control">
			</div>
			<div class="search-cell width-10 form-group">
				<label for="state">状态:</label> <select name="status" id="state" class="form-control">
				</select>
			</div>
			<div style="vertical-align: bottom" class="search-cell width-15">
				<button class="btn btn-default" id="btn_search"><i class="fa fa-search"></i> 查询</button>
				<a class="btn btn-primary" sec:authorize="hasRole('ROLE_VENDOR')"  th:href="@{/delivery/add}"><i class="fa fa-plus-circle"></i> 新建</a>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				<table id="example" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
				</table>
			</div>
		</div>
	</div>
</body>
</html>
<script th:inline="javascript" sec:authorize="hasRole('ROLE_VENDOR')">
	is_vendor = 1;
</script>
<script th:inline="javascript">
	/*[+
   var list_url = [[@{/delivery/list}]];
   var edit_url = [[@{/delivery/}]];
   +]*/

  $(document).ready(function() {

	  if (is_vendor) {
		  $('#vendor_div').addClass('hidden');
	  }
	  
	  $("#state").select2({
	    data : App.getDeliveryStateDataWithAll(),
	    minimumResultsForSearch : -1
	  });

	  var table = $('#example').DataTable({
	    ordering : true,
	    scrollY : '355px',
	    ajax : {
	      url : list_url,
	      data : function(data) {
		      var filter = {
		        order : data.columns[data.order[0].column].data,
		        dir : data.order[0].dir,
		        rows_per_page : data.length,
		        page_index : data.start / data.length + 1,
		        vendor : $('#vendor').val(),
		        state : $('#state').val(),
		        code : $('#code').val(),
		        is_vendor : is_vendor,
		      }
		      return filter;
	      },
	      dataSrc : function(json) {
		      json.recordsTotal = json.totalElements;
		      json.recordsFiltered = json.totalElements;
		      return json.content;
	      },
	    },
	    createdRow : function(row, data, dataIndex) {
		    $(row).addClass('');
	    },
	    columns : [ {
	      data : 'code',
	      title : '发货单号',
	      render : function(data, display, record) {
		      var url = edit_url + data + '/edit';
		      return '<a href="' + url + '">' + data + '</a>';
	      },
	    }, {
	      data : 'vendor_name',
	      visible : !is_vendor,
	      title : '供应商名称',
	    }, {
	    	visible : !is_vendor,
	      data : 'contact',
	      title : '联系人',
	    }, {
	      data : 'company_name',
	      title : '业务实体',
	    }, {
	      data : 'store_name',
	      className : 'dt-center',
	      title : '收货仓库',
	    }, {
	      data : 'store_address',
	      className : 'dt-center',
	      title : '仓库地址',
	    }, {
	      data : 'create_date',
	      title : '申请时间',
	      className : 'dt-center',
	      render : $.fn.date_renderer
	    }, {
	      data : 'estimated_arrival_date',
	      title : '预计到货时间',
	      className : 'dt-center',
	      render : $.fn.date_renderer
	    }, {
	      data : 'state',
	      title : '状态',
	      className : 'dt-center',
	      createdCell : App.getDeliveryStateClass,
	      render : App.getDeliveryStateOfId
	    } ],
	    order : [ [ 1, "desc" ] ]

	  });

	  $("#btn_search").click(function() {
		  table.draw();
	  });

	  $('#state').change(function() {
		  table.draw();
	  });

	  $('#vendor, #inventory, #start_date, #end_date').keyup(function(e) {
		  if (e.keyCode == 13)
			  table.draw();
	  });
  });
</script>