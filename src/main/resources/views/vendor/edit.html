<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" >
<head>
</head>
<body>
  <div class="container"  layout:fragment="content">  
      <ul class="breadcrumb">
        <li>
          <a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a>
        </li>
        <li sec:authorize="hasRole('ROLE_BUYER')"><a href="#">基础资料</a></li>
        <li><a th:href="@{/vendor}">供应商管理</a></li>
        <li class="active" th:text="${#strings.contains(#request.requestURI,'add')} ?'新建供应商':'供应商详细'">详细信息</li>
      </ul>

      <div class="btn-group-bar">
        <div class="text-right">
          <a class="btn btn-primary" sec:authorize="hasRole('ROLE_ADMIN') or hasAuthority('基础资料-新建供应商')" th:if="${data.code}" id="modify"><i class="fa fa-save"></i> 修改</a>  
          <a class="btn btn-primary" sec:authorize="hasRole('ROLE_ADMIN') or hasAuthority('基础资料-新建供应商')" th:if="${accountState!=1}" id="start"><i class="fa fa-save"></i> 启用</a>  
          <a class="btn btn-primary" sec:authorize="hasRole('ROLE_ADMIN') or hasAuthority('基础资料-新建供应商')" th:if="${accountState!=0}" id="delete"><i class="fa fa-remove"></i> 停用</a>
          <a class="btn btn-default" th:href="@{/vendor}"><i class="fa fa-arrow-left"></i> 返回列表</a>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-body">
        <form id="form" th:action="@{/vendor/update}" method="post">
          <input type="hidden" id="state" name="state" value="1"/>
          <div class="row">
              <div class="col-lg-4 col-md-4">
                <label>供应商编码: </label>
                <input type="text" name="code" id="vendor_code" class="form-control select-vendor" readonly th:value="${data.code}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>供应商名称: </label>
                <input type="text" id="vendor_name" class="form-control select-vendor" readonly  th:value="${data.name}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>供应商简称: </label>
                <input type="text" id="vendor_abbrname" class="form-control" readonly th:value="${data.abbrname}"/>
              </div>

              <div class="col-lg-4 col-md-4">
                <label>地址: </label>
                <input type="text" id="vendor_address" class="form-control" readonly th:value="${data.address}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>开户银行: </label>
                <input type="text" id="vendor_bank_open" class="form-control" readonly th:value="${data.bankOpen}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>银行账号: </label>
                <input type="text" id="vendor_bank_acc_number" class="form-control" readonly th:value="${data.bankAccNumber}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>联系人: </label>
                <input type="text" id="vendor_contact" class="form-control" readonly th:value="${data.contact}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>手机: </label>
                <input type="text" id="vendor_mobile" class="form-control" readonly th:value="${data.mobile}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>电话: </label>
                <input type="text" id="vendor_phone" class="form-control" readonly th:value="${data.phone}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>传真: </label>
                <input type="text" id="vendor_fax" class="form-control" readonly th:value="${data.fax}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>Email地址: </label>
                <input type="text" id="vendor_email" class="form-control" readonly th:value="${data.email}"/>
              </div>
              <div class="col-lg-4 col-md-4">
                <label>所属类别: </label>
                <input type="text" id="vendor_sort_code" class="form-control" readonly th:value="${data.sortCode}"/>
              </div>
              <div class="col-lg-4 col-md-4 hidden">
                <label>所属行业: </label>
                <input type="text" id="vendor_industry" class="form-control" readonly th:value="${data.industry}"/>
              </div>
              <div class="col-lg-4 col-md-4 hidden">
                <label>变更日期: </label>
                <input type="text" id="vendor_timestamp" class="form-control" readonly th:value="${data.timestamp}"/>
              </div>
            </div>
			<div class="row">
				<div class="col-lg-8 col-md-8">
					<label for="provideclasses">供货类别:</label>
					<select multiple="true" name="provideclasses" id="provideclasses" class="form-control" th:each="provideClass : ${provideClassList}">
					</select>
				</div>
				<div class="col-lg-4 col-md-4" id="invoice_type_div">
                  <label for="account_state">供应商账号状态: </label>
                  <select id="account_state" class="form-control" readonly></select>
                </div>
			</div>            
        </form>
        </div>
        <div class="modal fade" id="vendor_dialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document" style="width:1000px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">
                                                        选择供应商
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        </button>
                    </div>
                    <div class="modal-body form-horizontal">

                      <div class="search-content">
                          <div class="search-cell width-10">
                            <label for="search_keyword">供应商编码/名称：</label>
                            <input type="text" id="search_keyword" class="form-control">
                          </div>
                          <div style="vertical-align: bottom" class="search-cell width-15">
                            <button class="btn btn-default" id="btn_search"><i class="fa fa-search"></i> 查询</button>
                          </div>
                      </div>
                
                      <div class="row">
                        <div class="col-lg-12">
				            <table id="vendor_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width:100%">
				            </table>
				        </div>
				      </div>  
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="save_vendor">保存</button>
                    </div>
                </div>
            </div>
        </div>
  </div>  
  </div>
</body>
</html>

<script th:inline="javascript" sec:authorize="hasRole('ROLE_ADMIN')">
is_admin = 1;
</script>

<script th:inline="javascript">

/*[+
var search_url = [[@{/provideclass/search}]];
var search_admin_url = [[@{/provideclass/search}]];
var tree_url = [[@{/unit/tree}]];  
var edit_url = [[@{/vendor/}]];
var account_state = [[${accountState}]];
+]*/ 



$(document).ready(function() {
	
	if ($('#modify').length > 0) {
		is_readonly = 0;
	}
	
	var vendor_table;
	$("#provideclasses").select2(App.getSelect2TagOptions(is_admin?search_admin_url:search_url));
	$("#account_state").select2({ data: [{id:2, text:"  "}, ...App.getAccountStateData()],minimumResultsForSearch: -1}).select2("val", account_state.toString());
	var data = $.parseJSON(/*[[${provideClassList}]]*/'');
	$.each(data, function(key, item){
	  var option = new Option(item.name + '(' + item.code + ')', item.id, true, true);
	  $("#provideclasses").append(option);
	})
	$("#provideclasses").trigger('change');
  
	if (is_readonly) {
		$("#provideclasses").select2("enable", false);
	}
	$('.modal').on('shown.bs.modal', function () {
	  if (vendor_table) {
		  return;
	  }
	  
	  vendor_table = $('#vendor_table').DataTable({
	      ordering: true,
	      select: {
	    	style: 'single',  
	      },
	      ajax : {
	          url : /*[[@{/vendor/listall}]]*/'',
	          data : function(data) {
	              var filter = {
	                  rows_per_page : data.length,
	                  page_index : data.start / data.length + 1,
	                  order: data.columns[data.order[0].column].data,
	                  dir:data.order[0].dir,
	                  search: $('#search_keyword').val()
	              }
	              return filter;
	          },
	          dataSrc : function(json) {
	            json.recordsTotal = json.totalElements;
	            json.recordsFiltered = json.totalElements;
	            return json.content;
	          },
	      },
	      
	      columns : [ {
	          data : 'code',
	          title : '供应商编码',
	      }, {
	          data : 'name',
	          title : '供应商名称',
	      }, {
	          data : 'abbrname',
	          title : '供应商简称',
	      }, {
	          data : 'address',
	          title : '地址',
	      }, {
	          data : 'bank_open',
	          title : '开户银行',
	      }, {
	          data : 'bank_acc_number',
	          title : '银行帐号',
	      }, {
	          data : 'fax',
	          title : '传真 ',
	      }, {
	          data : 'email',
	          title : 'Email地址',
	      }, {
	          data : 'mobile',
	          className: 'dt-right',
	          title : '手机',
	      }, {
	          data : 'receive_site',
	          title : '到货地址',                
	      }, {
	          data : 'end_date',
	          className: 'dt-center',
	          render : $.fn.date_renderer,
	          title : '停用日期',                
	      } ],
	  });
	});
  
  
	if (account_state == 2) {
		$(".select-vendor").click(function(){  //"select all" change
		  $('#vendor_dialog').modal('show');
		});
	}
	
	$('#search_keyword').keyup(function(e){
	    if(e.keyCode == 13)
	  	  vendor_table.draw();
	});
  
	$("#btn_search").click(function() {
		vendor_table.draw();
	});
  
	$("#delete").click(function() {
		$('#state').val(0);
		save();
	});
	$("#start").click(function() {
		if (!$('#vendor_code').val()) {
			App.showErrorDialog("操作失败", "请选择供应商");
			return;
		}
		$('#state').val(1);
		save();
	});
	
	$("#modify").click(function() {
		$('#state').val(2);
		save();
	});
	
	function save() {
	    jQuery(form).ajaxSubmit({
	      beforeSend: function(){
	        App.blockUI();
	      },
	      complete: function(){
	        App.unblockUI();
	      },
	      success: function(res, status, xhr, form) {
	    	  if (res.success) {
	    		  App.showSuccessDialog("操作成功", function() {
	    			  window.location.href = edit_url + res.data.code + "/edit";
    			  });
    		  } else {
    			  App.showErrorDialog("操作失败", res.errmsg);
   			  }
	      },
	      error: function (res, status, xhr, form) {
	        App.showErrorDialog("操作失败", "请输入正确的值");
	      }
	    });
	}
	
	$("#save_vendor").click(function() {
		var selectedRows = vendor_table.rows('.selected').data();
		if (selectedRows.length == 0) {
		  App.showErrorDialog("请选择一个供应商");
		  return;
		}	  
		
		var vendor = selectedRows[0];
		if (vendor.state != null) {
			window.location.href = edit_url + vendor.code + "/edit";
		} else {
			$('#vendor_name').val(vendor.name);
			$('#vendor_abbrname').val(vendor.abbrname);
			$('#vendor_address').val(vendor.address);
			$('#vendor_bank_acc_number').val(vendor.bank_acc_number);
			$('#vendor_bank_open').val(vendor.bank_open);
			$('#vendor_code').val(vendor.code);
			$('#vendor_contact').val(vendor.contact);
			$('#vendor_email').val(vendor.email);
			$('#vendor_end_date').val(vendor.end_date);
			$('#vendor_fax').val(vendor.fax);
			$('#vendor_industry').val(vendor.industry);
			$('#vendor_mobile').val(vendor.mobile);
			$('#vendor_receive_site').val(vendor.receive_site);
			$('#vendor_sort_code').val(vendor.sort_code);
			$('#vendor_timestamp').val(vendor.timestamp);
			$('#vendor_dialog').modal('hide');
		}
		
	});
  

});

</script>
