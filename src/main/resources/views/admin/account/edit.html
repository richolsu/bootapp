<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<body>
	<div class="container" layout:fragment="content">
		<ul class="breadcrumb">
			<li><a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a></li>
			<li><a th:href="@{/account}">用户管理</a></li>
			<li class="active" th:text="${account.id}?'用户详细':'新建用户'"></li>
		</ul>
		<div class="btn-group-bar">
			<div class="text-right">
				<a class="btn btn-primary" id="save"><i class="fa fa-save"></i> 保存</a> <a class="btn btn-danger" id="del" th:if="${account.id}"><i class="fa fa-remove"></i> 删除</a> <a class="btn btn-default" th:href="@{/account}"><i class="fa fa-arrow-left"></i> 返回列表</a>
			</div>
		</div>
		<form id="form" th:action="@{/account/update}" method="post">
			<input type="hidden" id="id" name="id" th:value="${account.id}"> <input type="hidden" id="role" name="role" th:value="${account.role}">
			<div class="panel panel-default">
				<div class="panel-body form-body">
					<div class="row">
						<div class="col-md-3 form-group">
							<label for="account_no">员工编号：</label> <input type="text" id="account_no" name="account_no" class="form-control" th:value="${account.realname}">
						</div>
						<div class="col-md-3 form-group">
							<label for="realname">姓名：</label> <input type="text" id="realname" name="realname" class="form-control" th:value="${account.realname}">
						</div>
						<div class="col-md-3 form-group">
							<label for="duty">职位: </label> <input type="text" id="duty" name="duty" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="company">业务实体： </label> <input type="text" id="company" name="company" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="unit">部门： </label> <input type="text" id="unit" name="unit" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="mobile">手机:</label> <input type="text" id="mobile" name="mobile" class="form-control" th:value="${account.mobile}">
						</div>
						<div class="col-md-3 form-group">
							<label for="tel">电话:</label> <input type="text" name="tel" class="form-control" th:value="${account.tel}">
						</div>
						<div class="col-md-3 form-group">
							<label for="email">邮箱:</label> <input type="text" id="email" name="email" class="form-control" th:value="${account.email}">
						</div>
					</div>
					<div class="row">
						<div class="col-md-2 form-group">
							<label for="username">用户名: </label> <input type="text" name="username" id="username" class="form-control" th:value="${account.username}">
						</div>
						<div class="col-md-2 form-group">
							<label for="init_password">初始密码： </label> <input type="text" name="init_password" id="init_password" class="form-control" th:value="${account.username}">
						</div>
						<div class="col-md-2 form-group">
							<label for="state">状态: </label>
							<div class="ui toggle checkbox">
								<input type="checkbox" name="state" value="1" th:checked="${account.state}"> <label>启用 / 停用</label>
							</div>
						</div>
						<div class="col-md-3 form-group">
							<label for="start_date">启用日期: </label> <input type="text" class="form-control" readonly th:value="${#dates.format(account.startDate, 'yyyy-MM-dd')}">
						</div>
						<div class="col-md-3 form-group">
							<label for="stop_date">停用日期:</label> <input type="text" class="form-control" readonly th:value="${#dates.format(account.stopDate, 'yyyy-MM-dd')}">
						</div>
					</div>
				</div>
			</div>
		</form>
		<div class="row">
			<div class="col-md-4 form-group">
				<table id="permission_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
				</table>
			</div>
			<!-- TABS -->
			<div class="col-md-8 tab-style-1" id="scope_tabs">
				<ul class="nav nav-tabs">
					<li class="active"><a data-toggle="tab" href="#company_scope" id="company_tab">公司</a></li>
					<li class=""><a data-toggle="tab" href="#account_scope" id="account_tab">采购员</a></li>
					<li class=""><a data-toggle="tab" href="#store_scope" id="store_tab">库房</a></li>
					<li class=""><a data-toggle="tab" href="#vendor_scope" id="vendor_tab">供应商</a></li>
					<li class=""><a data-toggle="tab" href="#inventory_scope" id="inventory_tab">商品分类</a></li>
				</ul>
				<div class="tab-content">
					<div id="company_scope" class="tab-pane row fade active in">
						<table id="company_scope_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
						</table>
					</div>
					<div id="account_scope" class="tab-pane row fade">
						<table id="account_scope_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
						</table>
					</div>
					<div id="store_scope" class="tab-pane fade">
						<table id="store_scope_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
						</table>
					</div>
					<div id="vendor_scope" class="tab-pane fade">
						<table id="vendor_scope_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
						</table>
					</div>
					<div id="inventory_scope" class="tab-pane fade">
						<table id="inventory_scope_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
						</table>
					</div>
				</div>
			</div>
		</div>
</body>
</html>
<script th:inline="javascript">
	var edit_url = /*[[@{/account/}]]*/'';
  var tree_url = /*[[@{/unit/tree}]]*/'';
  var checkuser_url = /*[[@{/account/checkuser/}]]*/'';
  var checkemail_url = /*[[@{/profile/checkemail}]]*/'';
  var checkmobile_url = /*[[@{/profile/checkmobile}]]*/'';
  var checkweixin_url = /*[[@{/profile/checkweixin}]]*/'';
  var perm_search_url = /*[[@{/permission_group/search}]]*/'';
  var account_url = /*[[@{/account/search/}]]*/'';
  var table, company_table, account_table, store_table, vendor_table, inventory_table;

  jQuery(document).ready(function() {

	  function onCheckVendor(isVendor) {
		  if (isVendor) {
			  $('#username').prop('readonly', true);
			  $('#realname').prop('readonly', true);
			  $('#duty').prop('readonly', true);
			  $('#unit_name').prop('disabled', true);
			  $('#form').validate().settings.rules.email.required = true;
			  $('#form').validate().settings.rules.mobile.required = true;
			  $('#form').validate().settings.rules.weixin.required = true;
		  } else {
			  $('#username').prop('readonly', false);
			  $('#realname').prop('readonly', false);
			  $('#duty').prop('readonly', false);
			  $('#unit_name').prop('disabled', false);
			  $('#form').validate().settings.rules.email.required = false;
			  $('#form').validate().settings.rules.mobile.required = false;
			  $('#form').validate().settings.rules.weixin.required = false;

		  }
	  }

	  var is_add = $("#id").val().length == 0;
	  $("#form").validate({
	    // define validation rules
	    rules : {
	      realname : {
		      required : true
	      },
	      duty : {
		      required : true
	      },
	      username : {
	        required : true,
	        remote : {
	          url : checkuser_url,
	          data : {
	            username : function() {
		            return $("#username").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	      email : {
	        required : true,
	        email : true,
	        remote : {
	          url : checkemail_url,
	          data : {
	            email : function() {
		            return $("#email").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	      mobile : {
	        required : true,
	        remote : {
	          url : checkmobile_url,
	          data : {
	            mobile : function() {
		            return $("#mobile").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	    },
	    messages : {
	      username : {
		      remote : "该用户名已在使用！"
	      },
	      email : {
		      remote : "该邮箱已在使用！"
	      },
	      mobile : {
		      remote : "该手机号已在使用！"
	      },
	    },

	    //display error alert on form submit
	    invalidHandler : function(event, validator) {
		    App.showErrorDialog("输入有误", "请输入正确的值");
	    },

	    submitHandler : function(form) {
		    jQuery(form).ajaxSubmit({
		      data : {
			      permissions : [ {
				      1 : [ {} ]
			      } ],
		      },
		      beforeSend : function() {
			      App.blockUI();
		      },
		      complete : function() {
			      App.unblockUI();
		      },
		      success : function(res, status, xhr, form) {
			      if (res.success == 1) {
				      App.showSuccessDialog("操作成功", function() {
					      window.location.href = edit_url + res.data.id + "/edit";
				      });
			      } else {
				      App.showErrorDialog("操作失败", res.errmsg);
			      }
		      },
		      error : function(res, status, xhr, form) {
			      App.showErrorDialog("操作失败", "请输入正确的值");
		      }
		    });
	    }
	  });

	  $("#save").click(function() {
		  $("#form").submit();
	  });

	  $("#del").click(function() {
		  App.showConfirmDialog('确定要删除吗?', function() {
			  var del_url = edit_url + $("#id").val() + "/delete";
			  $.get(del_url, function(data, status) {
				  App.showSuccessDialog("操作成功", function() {
					  window.location.href = edit_url;
				  });
			  });
		  });
	  });

	  //Permission Table
	  table = $('#permission_table').DataTable({
	    ordering : true,
	    serverSide : false,
	    processing : false,
	    select : {
	      style : 'multi',
	      selector : 'td:first-child'
	    },
	    ajax : {
	      url : /*[[@{|/permission_group/list_of_account/${account.id}|}]]*/'',
	      dataSrc : function(json) {
		      for (var i = 0; i < json.length; i++) {
			      json[i].selected = true;
			      json[i].select = true;
		      }
		      return json;
	      },
	    },
	    rowCallback: function (row, data) {
		    if (data.selected) {
		    	$(row).addClass('selected');
		    }
	    },
	    order : [ [ 1, 'asc' ] ],
	    columns : [ {
	      data : null,
	      defaultContent : '',
	      orderable : false,
	      className : 'select-checkbox',
	    }, {
	      data : 'name',
	      title : '权限名',
	    } ],
	  });

	  var currentPermissionGroupId;
	  $('#permission_table tbody').on('click', 'tr', function() {
		  $("#company_tab").hide();
		  $("#account_tab").hide();
		  $("#store_tab").hide();
		  $("#vendor_tab").hide();
		  $("#inventory_tab").hide();
		  $("#company_tab").show();
		  $("#account_tab").show();

		  var clicked_row_data = table.row(this).data();

		  currentPermissionGroupId = clicked_row_data.id;
		  loadScopeTab();
	  });

	  $('#scope_tabs').tabs();
	  function loadScopeTab() {
		  //Company Scope Table	  
		  if (company_table) {
			  company_table.clear().destroy();
		  }

		  company_table = $('#company_scope_table').DataTable({
		    ordering : true,
		    serverSide : false,
		    processing : false,
		    destroy : true,
		    ajax : {
		      url : /*[[@{|/permission_group/list_of_account/${account.id}|}]]*/'',
		      dataSrc : function(json) {
			      return json;
		      },
		    },
		    order : [ [ 0, 'asc' ] ],
		    columns : [ {
		      data : 'name',
		      title : '权限名',
		    }, {
		      data : 'description',
		      title : '描述',
		    } ],
		  });

		  $('#company_tab').click();
	  }

  });
</script>
