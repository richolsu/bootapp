<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
<head>
<style>
    .select-unit {background-color:#fff !important}
</style>
</head>  
<body>
  <div class="container" layout:fragment="content">
    <ul class="breadcrumb">
      <li>
        <a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a>
      </li>
      <li><a th:href="@{/admin/account}">用户管理</a></li>
      <li class="active">用户详细</li>
    </ul>
    <div class="btn-group-bar">
      <div class="text-right margin-right-20">
          <a class="btn btn-primary" id="save"><i class="fa fa-save"></i> 保存</a>
          <a class="btn btn-danger" id="del"><i class="fa fa-remove"></i> 删除</a>
          <a class="btn btn-default" th:href="@{/admin/account}"><i class="fa fa-arrow-left"></i> 返回</a>
      </div>
    </div>
    <form id="form" th:action="@{/admin/account/update}" method="post">  
    <input type="hidden" id="id" name="id" th:value="${account.id}">
    <div class="panel panel-default">
      <div class="panel-body"> 
        <div class="row">
          <div class="content-form-page">
            <fieldset>
              <legend>基本信息</legend>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">真实姓名: </label>
                <input type="text" name="realname" class="form-control" th:value="${account.realname}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">所属部门: </label>
                <input type="hidden" id="unit" name="unit" th:value="${account.unit==null?'':account.unit.id}">
                <input type="text" id="unit_name" name="unit_name" class="form-control select-unit" th:value="${account.unit==null?'':account.unit.name}" readonly>
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">职位: </label>
                <input type="text" name="duty" th:value="${account.duty}" class="form-control">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="entry_date">入职日期: </label>
                <input type="text" class="form-control datepicker" name="entry_date" id="entry_date" th:value="${#dates.format(account.entryTime, 'yyyy-MM-dd')}">
              </div>
            </fieldset>
            <fieldset>
              <legend>账号信息</legend>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">用户名: </label>
                <input type="text" name="username" class="form-control" th:value="${account.username}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">密码: </label>
                <input type="password" name="password" class="form-control">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">角色: </label>
                <select name="role" id="role" class="form-control">
                  <option value="ROLE_BUYER" th:selected="(${account.role}=='ROLE_BUYER')">采购员</option>
                  <option value="ROLE_VENDOR" th:selected="(${account.role}=='ROLE_VENDOR')">供应商</option>
                  <option value="ROLE_ADMIN"  th:selected="(${account.role}=='ROLE_ADMIN')">管理员</option>
                </select>
              </div>
              <div class="col-lg-6 col-md-6 form-group">
                  <label for="vendor">供应商:</label>
                  <select id="vendor" name="vendor" class="form-control">
                    <option th:if="${account.vendor != null}" th:value="${account.vendor.code}" th:text="${account.vendor.name}" selected="selected"></option>
                  </select>
                </div>
            </fieldset>
            <fieldset>
              <legend>联系信息</legend>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">Skype: </label>
                <input type="text" name="skype" class="form-control" th:value="${account.skype}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">QQ: </label>
                <input type="text" name="qq" class="form-control" th:value="${account.qq}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">雅虎通: </label>
                <input type="text" name="yahoo" class="form-control" th:value="${account.yahoo}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="document_date">GTalk: </label>
                <input type="text" name="gtalk" class="form-control" th:value="${account.gtalk}">
              </div>
              <div class="col-lg-4 col-md-4 form-group">
                <label for="document_date">旺旺: </label>
                <input type="text" name="wangwang" class="form-control" th:value="${account.wangwang}">
              </div>                                                
              <div class="col-lg-2 col-md-2 form-group">
                <label for="effective_date">手机:</label>
                <input type="text" name="mobile" class="form-control" th:value="${account.mobile}">
              </div>
              
              <div class="col-lg-2 col-md-2 form-group">
                <label for="tax_rate">电话:</label>
                <input type="text" name="tel" class="form-control" th:value="${account.tel}">
              </div>
              <div class="col-lg-2 col-md-2 form-group">
                <label for="tax_rate">邮箱:</label>
                <input type="text" name="email" class="form-control" th:value="${account.email}">
              </div>
              <div class="col-lg-6 col-md-6 form-group">
                <label for="address">通讯地址:</label>
                <input type="text" name="address" class="form-control datepicker" th:value="${account.address}">
              </div>
            </fieldset>
          </div>
        </div>
      </div>

    </form>
    <div class="modal fade" id="tree_dialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                                                    选择所属部门
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <i class="fa fa-sitemap"></i> 组织结构
                    <div id="tree_3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save_unit">保存</button>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>
</html>


<script th:inline="javascript">
var edit_url = /*[[@{/admin/account/}]]*/'';
var tree_url = /*[[@{/api/unit/tree}]]*/'';
var vendor_search_url = /*[[@{/api/vendor/select}]]*/'';

jQuery(document).ready(function() {   
    $('.datepicker').datepicker();
    $('#role').select2({minimumResultsForSearch: -1});
    $("#vendor").select2(App.getSelect2Options(vendor_search_url));
    
    $('#role').change(function() {
      if ($('#role').val() == 'ROLE_VENDOR') {
        $('#vendor').removeClass('hidden');
        $('#vendor').prop('disabled', false);
      }else{
        $('#vendor').addClass('hidden');
        $('#vendor').prop('disabled', true);
      }
    });
    
    $('#role').trigger('change');
    
    var is_add = $("#id").val().length==0;
    $("#form" ).validate({
        // define validation rules
        rules: {
        	realname: {
                required: true
            }, 
            duty: {
                required: true
            },
            username: {
                required: true
            },    
            password: {
                required: true
            },    
            unit_name: {
            	required: true
            },
            role: {
                required: true
            },    
        },
        
        //display error alert on form submit  
        invalidHandler: function(event, validator) {
            swal({
                "title": "输入有误", 
                "text": "请输入正确的值", 
                "type": "error"
            });
        },
  
        submitHandler: function (form) {
            jQuery(form).ajaxSubmit({
                success: function(res, status, xhr, form) {
                    swal({
                        "title": "操作成功", 
                        "type": "success"
                    }).then((result) => {
                        if (is_add)
                            window.location.href = edit_url + res.id + "/edit";
                    });
                },
                error: function (res, status, xhr, form) {
                    swal({
                        "title": "操作失败", 
                        "text": "请输入正确的值", 
                        "type": "error"
                    });
                }
            });
        }
      }); 
    
    $("#save").click(function() {
        $("#form").submit();            
    });
    
    $("#del").click(function(){
        swal({
          title: '确定要删除吗?',
          type: 'warning',
          showCancelButton: true,
          confirmButtonText: '是',
          cancelButtonText: '否'
        }).then((result) => {
          if (result.value) {
              var del_url = edit_url + $("#id").val() + "/delete";  
              $.get(del_url, function(data, status){
                swal({
                      "title": "操作成功", 
                      "type": "success"
                  }).then((result) => {
                      window.location.href = edit_url;
                  });
              });
          }
        })
    });

    $(".select-unit").click(function(){  //"select all" change
        $('#tree_3').jstree(true).deselect_all();
        var unit_id = $('#unit').val();
        
        $('#tree_3').jstree(true).select_node(unit_id);
        $('#tree_dialog').modal('show');
    });
    
    $("#tree_3").jstree({
      'plugins': ["types"],
      'core': {
          'data' : {
            'url' : function (node) {
              return tree_url;
            }
          }
      },
      "types" : {
          "default" : {
              "icon" : "fa fa-folder m--font-warning"
          },
          "file" : {
              "icon" : "fa fa-file  m--font-warning"
          }
      },
    }).on('loaded.jstree', function() {
        $(this).jstree("open_all");
    });

    $('#save_unit').click(function(){
    	var selected_node = $("#tree_3").jstree("get_selected",true);
    	
    	if (selected_node.length == 0) {
    		swal({
                "title": "请选择一个部门", 
                "type": "error"
            });
    		
    		n;
    	}
        var selected_unit_id = selected_node[0].id; 
        var selected_unit_name = selected_node[0].text;
        $('#unit').val(selected_unit_id);
        $('#unit_name').val(selected_unit_name);
        $('#tree_dialog').modal('hide');//modal_1 is the id 1
     });

});


</script>

