<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<body>
	<div class="container" layout:fragment="content">
		<ul class="breadcrumb">
			<li><a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a></li>
			<li><a th:href="@{/account}">用户管理</a></li>
			<li class="active" th:text="${account.id}?'用户详细':'新建用户'"></li>
		</ul>
		<div class="btn-group-bar">
			<div class="text-right">
				<a class="btn btn-primary" id="save"><i class="fa fa-save"></i> 保存</a> <a class="btn btn-danger" id="del" th:if="${account.id}"><i class="fa fa-remove"></i> 删除</a> <a class="btn btn-default" th:href="@{/account}"><i class="fa fa-arrow-left"></i> 返回列表</a>
			</div>
		</div>
		<form id="form" th:action="@{/account/update}" method="post">
			<input type="hidden" id="id" name="id" th:value="${account.id}"> <input type="hidden" id="role" name="role" th:value="${account.role}">
			<div class="panel panel-default">
				<div class="panel-body form-body">
					<div class="row">
						<div class="col-md-3 form-group">
							<label for="account_no">员工编号：</label> <input type="text" id="account_no" name="account_no" class="form-control" th:value="${account.realname}">
						</div>
						<div class="col-md-3 form-group">
							<label for="realname">姓名：</label> <input type="text" id="realname" name="realname" class="form-control" th:value="${account.realname}">
						</div>
						<div class="col-md-3 form-group">
							<label for="duty">职位: </label> <input type="text" id="duty" name="duty" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="company">业务实体： </label> <input type="text" id="company" name="company" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="unit">部门： </label> <input type="text" id="unit" name="unit" th:value="${account.duty}" class="form-control">
						</div>
						<div class="col-md-3 form-group">
							<label for="mobile">手机:</label> <input type="text" id="mobile" name="mobile" class="form-control" th:value="${account.mobile}">
						</div>
						<div class="col-md-3 form-group">
							<label for="tel">电话:</label> <input type="text" name="tel" class="form-control" th:value="${account.tel}">
						</div>
						<div class="col-md-3 form-group">
							<label for="email">邮箱:</label> <input type="text" id="email" name="email" class="form-control" th:value="${account.email}">
						</div>
					</div>
					<div class="row">
						<div class="col-md-2 form-group">
							<label for="username">用户名: </label> <input type="text" name="username" id="username" class="form-control" th:value="${account.username}">
						</div>
						<div class="col-md-2 form-group">
							<label for="init_password">初始密码： </label> <input type="text" name="init_password" id="init_password" class="form-control" th:value="${account.username}">
						</div>
						<div class="col-md-2 form-group">
							<label for="state">状态: </label>
							<div class="ui toggle checkbox">
								<input type="checkbox" name="state" value="1" th:checked="${account.state}"> <label>启用 / 停用</label>
							</div>
						</div>
						<div class="col-md-3 form-group">
							<label for="start_date">启用日期: </label> <input type="text" class="form-control" readonly th:value="${#dates.format(account.startDate, 'yyyy-MM-dd')}">
						</div>
						<div class="col-md-3 form-group">
							<label for="stop_date">停用日期:</label> <input type="text" class="form-control" readonly th:value="${#dates.format(account.stopDate, 'yyyy-MM-dd')}">
						</div>
					</div>
				</div>
			</div>
		</form>
		<div class="row">
			<div class="col-md-12 form-group">
				<table id="permission_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
				</table>
			</div>
		</div>
		<div class="modal fade" id="import_permission_dialog" role="dialog" aria-hidden="true">
			<div class="modal-dialog" role="document" style="width: 1000px;">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">选择用户</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body form-horizontal">
						<div class="search-content">
							<div class="search-cell form-group">
								<label for="permission_search">权限名称：</label> <input type="text" id="permission_search" class="form-control">
							</div>
							<div style="vertical-align: bottom" class="search-cell form-group">
								<button class="btn btn-default" id="btn_permission_search">
									<i class="fa fa-search"></i> 查询
								</button>
							</div>
						</div>
						<div class="row">
							<div class="col-lg-12">
								<table id="import_permission_table" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
								</table>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" id="btn_import_permission">保存</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
<script th:inline="javascript">
	var edit_url = /*[[@{/account/}]]*/'';
  var tree_url = /*[[@{/unit/tree}]]*/'';
  var checkuser_url = /*[[@{/account/checkuser/}]]*/'';
  var checkemail_url = /*[[@{/profile/checkemail}]]*/'';
  var checkmobile_url = /*[[@{/profile/checkmobile}]]*/'';
  var checkweixin_url = /*[[@{/profile/checkweixin}]]*/'';
  var perm_search_url = /*[[@{/permission_group/search}]]*/'';
  var account_url = /*[[@{/account/search/}]]*/'';

  jQuery(document).ready(function() {

	  function onCheckVendor(isVendor) {
		  if (isVendor) {
			  $('#username').prop('readonly', true);
			  $('#realname').prop('readonly', true);
			  $('#duty').prop('readonly', true);
			  $('#unit_name').prop('disabled', true);
			  $('#form').validate().settings.rules.email.required = true;
			  $('#form').validate().settings.rules.mobile.required = true;
			  $('#form').validate().settings.rules.weixin.required = true;
		  } else {
			  $('#username').prop('readonly', false);
			  $('#realname').prop('readonly', false);
			  $('#duty').prop('readonly', false);
			  $('#unit_name').prop('disabled', false);
			  $('#form').validate().settings.rules.email.required = false;
			  $('#form').validate().settings.rules.mobile.required = false;
			  $('#form').validate().settings.rules.weixin.required = false;

		  }
	  }

	  var is_add = $("#id").val().length == 0;
	  $("#form").validate({
	    // define validation rules
	    rules : {
	      realname : {
		      required : true
	      },
	      duty : {
		      required : true
	      },
	      username : {
	        required : true,
	        remote : {
	          url : checkuser_url,
	          data : {
	            username : function() {
		            return $("#username").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	      email : {
	        required : true,
	        email : true,
	        remote : {
	          url : checkemail_url,
	          data : {
	            email : function() {
		            return $("#email").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	      mobile : {
	        required : true,
	        remote : {
	          url : checkmobile_url,
	          data : {
	            mobile : function() {
		            return $("#mobile").val();
	            },
	            id : function() {
		            return $("#id").val();
	            }
	          }
	        }
	      },
	    },
	    messages : {
	      username : {
		      remote : "该用户名已在使用！"
	      },
	      email : {
		      remote : "该邮箱已在使用！"
	      },
	      mobile : {
		      remote : "该手机号已在使用！"
	      },
	    },

	    //display error alert on form submit
	    invalidHandler : function(event, validator) {
		    App.showErrorDialog("输入有误", "请输入正确的值");
	    },

	    submitHandler : function(form) {
		    jQuery(form).ajaxSubmit({
		      data : {
			      permissions : [ {
				      1 : [ {} ]
			      } ],
		      },
		      beforeSend : function() {
			      App.blockUI();
		      },
		      complete : function() {
			      App.unblockUI();
		      },
		      success : function(res, status, xhr, form) {
			      if (res.success == 1) {
				      App.showSuccessDialog("操作成功", function() {
					      window.location.href = edit_url + res.data.id + "/edit";
				      });
			      } else {
				      App.showErrorDialog("操作失败", res.errmsg);
			      }
		      },
		      error : function(res, status, xhr, form) {
			      App.showErrorDialog("操作失败", "请输入正确的值");
		      }
		    });
	    }
	  });

	  $("#save").click(function() {
		  $("#form").submit();
	  });

	  $("#del").click(function() {
		  App.showConfirmDialog('确定要删除吗?', function() {
			  var del_url = edit_url + $("#id").val() + "/delete";
			  $.get(del_url, function(data, status) {
				  App.showSuccessDialog("操作成功", function() {
					  window.location.href = edit_url;
				  });
			  });
		  });
	  });

	  editor = new $.fn.dataTable.Editor({
	    table : "#example",
	    idSrc : "id",
	    i18n : {
	      remove : {
	        button : "删除行",
	        title : "删除",
	        submit : "是",
	        confirm : {
	          _ : "确定要删除%d行权限吗?",
	          1 : "确定要删除吗?"
	        }
	      },
	      error : {
		      system : "发生错误！"
	      }
	    }
	  });

	  table = $('#permission_table').DataTable({
	    ordering : true,
	    select : {
		    style : 'multi'
	    },
	    serverSide : false,
	    processing : false,
	    buttons : [ {
	      text : "添加权限",
	      action : function(e, dt, node, config) {
		      $('#import_permission_dialog').modal('show');
	      }
	    }, {
	      extend : "remove",
	      editor : editor
	    } ],
	    ajax : {
	      url : /*[[@{|/permission_group/list_of_account/${account.id}|}]]*/'',
	      dataSrc : function(json) {
		      return json;
	      },
	    },
	    order : [ [ 0, 'asc' ] ],
	    columns : [ {
	      data : 'name',
	      title : '权限名',
	    }, {
	      data : 'description',
	      title : '描述',
	    }, {
	      title : '应用权限',
	      render : function(data, display, record) {
		      var edit_url = /*[[@{/permission_group/}]]*/'';
		      edit_url += record.id + '/edit';
		      return '<a href="' + edit_url + '">' + "查看应用权限" + '</a>';
	      },
	    }, {
	      title : '业务范围',
	      render : function(data, display, record) {
		      var edit_url = /*[[@{/permission_group/}]]*/'';
		      edit_url += record.id + '/edit';
		      return '<a href="' + edit_url + '">' + "查看业务范围" + '</a>';
	      },
	    } ],
	  });

	  $('.modal').on('shown.bs.modal', function() {
		  $('#search_inventory').val('');
		  if (import_table == undefined) {
			  import_table = $('#import_account').DataTable({
			    ordering : true,
			    select : {
				    style : 'multi'
			    },
			    ajax : {
			      url : /*[[@{/account/list}]]*/'',
			      data : function(data) {
				      var filter = {
				        rows_per_page : data.length,
				        page_index : data.start / data.length + 1,
				        order : data.columns[data.order[0].column].data,
				        dir : data.order[0].dir,
				        search : $('#search').val(),
				        state : $('#state').val(),
				        except_vendor : "1",
				        role : $('#role').val()
				      }
				      return filter;
			      },
			      dataSrc : function(json) {
				      json.recordsTotal = json.totalElements;
				      json.recordsFiltered = json.totalElements;
				      return json.content;
			      },
			    },
			    order : [ [ 0, 'asc' ] ],
			    columns : [ {
			      data : 'username',
			      title : '用户名',
			    }, {
			      data : 'realname',
			      title : '真实姓名',
			    }, {
			      data : 'unitname',
			      title : '所属组织',
			    }, {
			      data : 'duty',
			      title : '职位',
			    }, {
			      data : 'role',
			      title : '角色',
			      render : App.getRoleOfId,
			    }, {
			      data : 'state',
			      title : '状态',
			      render : App.getAccountStateOfId,
			    }, {
			      data : 'vendorname',
			      title : '供应商',
			    }, {
			      data : 'email',
			      title : '邮箱',
			    }, {
			      data : 'tel',
			      title : '电话',
			    }, {
			      data : 'mobile',
			      title : '手机',
			    } ],
			  });
		  }
	  });

	  $('#btn_import').click(function() {
		  $('#import_dialog').modal('hide');//modal_1 is the id 1
		  var selected_data = import_table.rows('.selected').data().toArray();
		  var exist_data = table.rows().data().toArray();
		  $.each(selected_data, function(key, item) {

			  var available = true;
			  for (i = 0; i < exist_data.length; i++) {
				  exist_row = exist_data[i];
				  if (exist_row.id == item.id) {
					  available = false;
					  break;
				  }
			  }

			  if (available) {
				  var temp = $.extend(true, {}, item);
				  table.row.add(temp);
			  }

		  })

		  table.draw();

	  });

	  $("#btn_search").click(function() {
		  import_table.draw();
	  });

	  $('#state, #role').change(function() {
		  import_table.draw();
	  });

	  $('#search').keyup(function(e) {
		  if (e.keyCode == 13)
			  import_table.draw();
	  });

  });
</script>
