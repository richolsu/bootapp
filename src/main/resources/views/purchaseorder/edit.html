<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<body>
	<div class="container" layout:fragment="content">
		<ul class="breadcrumb">
			<li><a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a></li>
			<li><a th:href="@{/purchaseorder}">订单管理</a></li>
			<li class="active">订单详细</li>
		</ul>
		<div class="btn-group-bar">
			<div class="text-right" style="margin-top: 10px; margin-bottom: 5px;">
				<a class="btn btn-primary" id="deploy" sec:authorize="hasRole('ROLE_BUYER')" th:if="${(main.srmstate==0)} "><i class="fa fa-undo"></i> 发布</a> 
				<a class="btn btn-primary" id="negotiate" sec:authorize="hasRole('ROLE_BUYER')" th:if="${(main.srmstate==1)}" th:href="@{|/inquery/${main.code}/edit|}"><i class="fa fa-undo"></i> 发起议价</a> 
				<a class="btn btn-primary" id="confirm" sec:authorize="hasRole('ROLE_VENDOR')" th:if="${main.srmstate==1}"><i class="fa fa-arrow-up"></i> 确认</a> 
				<a class="btn btn-primary" id="close" sec:authorize="hasRole('ROLE_BUYER')" th:if="${main.srmstate>=1}"><i class="fa fa-undo"></i> 关闭</a>
				<a class="btn btn-primary" id="negotiate" sec:authorize="hasRole('ROLE_VENDOR')" th:if="${main.srmstate==1}"><i class="fa fa-undo"></i> 申请协调</a> 
				<a class="btn btn-primary" id="negotiate_ok" sec:authorize="hasRole('ROLE_BUYER')" th:if="${main.srmstate==2}"><i class="fa fa-arrow-up"></i> 协调同意</a> 
				<a class="btn btn-primary" id="negotiate_cancel" sec:authorize="hasRole('ROLE_BUYER')" th:if="${main.srmstate==2}"><i class="fa fa-undo"></i> 协调拒绝</a>
				<a class="btn btn-default" th:href="@{/purchaseorder}"><i	class="fa fa-arrow-left"></i> 返回列表</a>
			</div>
		</div>
		<div class="panel panel-default">
			<form id="form" th:action="@{/purchaseorder/update}" method="post"></form>
			<div class="panel-body">
				<div class="row">
					<div class="col-md-3">
						<label>业务类型： </label> <input type="text" id="code" class="form-control" th:value="${main.code}" readonly />
					</div>
					<div class="col-md-3">
						<label>订单日期： </label> <input type="text" class="form-control" th:value="${#dates.format(main.audittime, 'yyyy-MM-dd')}" readonly />
					</div>
					<div class="col-md-3">
						<label>订单编号： </label> <input type="text" id="code" class="form-control" th:value="${main.code}" readonly />
					</div>
					<div class="col-md-3">
						<label for="state">订单状态：</label> <select name="state" id="state" class="form-control" readonly>
						</select>
					</div>
				</div>
				<div class="row">
					<div class="col-md-3">
						<label>采购类型： </label> <input type="text" class="form-control" th:value="${main.purchaseTypeName}" readonly />
					</div>
					<div class="col-md-3">
						<label>供应商: </label> <input type="text" class="form-control" th:value="${main.vendor.name}" readonly />
					</div>
					<div class="col-md-3">
						<label>业务实体： </label> <input type="text" class="form-control" th:value="${main.vendor.name}" readonly />
					</div>
				</div>
				<div class="row">
					<div class="col-md-3">
						<label>业务员： </label> <input type="text" class="form-control" th:value="${main.reviewer?.realname}" readonly />
					</div>
					<div class="col-md-3">
						<label>汇率： </label> <input type="text" class="form-control" th:value="${main.vendor.address}" readonly />
					</div>
					<div class="col-md-3">
						<label>付款条件： </label> <input type="text" class="form-control" th:value="${main.remark}" readonly />
					</div>
					<div class="col-md-3">
						<label>&nbsp;</label>
						<div class="form-control no-border">
							<input type="checkbox" name="sms"><label>短信</label> <input type="checkbox" name="email"><label>邮件</label>
						</div>
					</div>
				</div>
				<div class="row margin-top-10">
					<div class="col-lg-12">
						<div class="detail-tabs margin-bottom-30">
							<div class="tab-style-1" id="tabs">
								<ul class="nav nav-tabs">
									<li class="active"><a data-toggle="tab" href="#tab-1">基本信息</a></li>
									<li><a data-toggle="tab" href="#tab-2">操作日志</a></li>
									<li><a data-toggle="tab" href="#tab-3">附件</a></li>
								</ul>
								<div class="tab-content">
									<div id="tab-1" class="tab-pane row-fluid fade in active">
										<table id="basic_info" class="table table-striped table-bordered nowrap table-striped table-hover" style="width: 100%">
											<tfoot>
												<tr>
													<th colspan="14" class="dt-center">合计</th>
													<th></th>
													<th></th>
													<th colspan="6"></th>
												</tr>
											</tfoot>
										</table>
									</div>
									<div id="tab-2" class="tab-pane row-fluid fade in">		
										<div class="operations" id="operation_history">
										</div>	
										<div class="row edit-history">
											<form id="history_form" th:action="@{/operation_history/update}" method="post">												
												<textarea name="content" id="history_content" class="history-content" rows="5"></textarea>
												<a class="btn btn-primary save-history" id="save_history"><i class="fa fa-plus"></i> 保存</a>
											</form>											 
										</div>							
									</div>
									<div id="tab-3" class="tab-pane row-fluid fade in">										
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
<script th:inline="javascript" sec:authorize="hasRole('ROLE_VENDOR')">
	is_vendor = 1;
</script>
<script th:inline="javascript" sec:authorize="hasRole('ROLE_VENDOR') or hasAuthority('订单管理-新建/发布')">
	is_readonly = 0;
</script>
<script th:inline="javascript">
	/*[+
   var detail_url = [[@{/purchaseorder/}]] + [[${main.code}]] + "/details";
	 var history_url = [[@{/operation_history/list/order/}]] + [[${main.code}]];
   var submit_url = [[@{/purchaseorder/update}]];
   var state = [[${main.srmstate}]];
   +]*/

  var editor;

  $(document).ready(function() {

	  Layout.initUniform();
	  $("#state").select2({
	    data : App.getPurchaseOrderStateData(),
	    minimumResultsForSearch : -1
	  }).select2("val", state.toString());

	  var basic_table, prepay_table;

	  $('#negotiate').click(function() {
	  	
	  });
	  
	  $('#save_history').click(function() {
	  	$("#history_form").ajaxSubmit({
	  		data : {
	  			target_type: "order",
	  			target_id: $('#code').val(),		      	
	      },
	      beforeSend: function(){
          App.blockUI();
        },
        complete: function(){
          App.unblockUI();
        },
        success: function(res, status, xhr, form) {
          if (res.success == 1) {
          	$('#history_content').val('');
          	loadHistory();
          }else{
            App.showErrorDialog(res.errmsg);
          }              
        },
        error: function (res, status, xhr, form) {
          App.showErrorDialog("操作失败", "请稍后重试");
        }
      });
	  });
	  
	  function loadHistory() {
	  	$.get(history_url, function(data, status) {
	  		$('#operation_history').empty();
	  		$.each(data, function(key, item) {
	  			var time = "<div class='operation-time'>" + $.fn.time_renderer(item.create_date) + "</div>";
	  			var content = "<div class='operation-content'>【" + item.account.realname + "】"+ item.content + "</div>";
	  			var record = "<div class='operation'>" + time + content + "</div>";
	  			$('#operation_history').append($(record));
	  		});
		  });
	  }
	  
	  loadHistory();
	  
	  $('#tabs').tabs({
		  activate : function(event, ui) {
		  }
	  });

	  editor = new $.fn.dataTable.Editor({
	    table : "#basic_info",
	    idSrc : "id",
	    fields : [ {
	      type : "date",
	      opts : {
	        showOn : "focus",
	        dateFormat : "yy-mm-dd",
	      },
	      name : "confirmed_date"
	    }, {
		    name : "confirmed_memo"
	    } ],
	  }).on('preSubmit', function(e, data, action) {
		
	  }).on('postEdit', function(e, json, data, action) {
		
	  });

	  basic_table = $('#basic_info').DataTable({
	    serverSide : false,
	    processing : false,
	    select : false,
	    ajax : {
	      url : detail_url,
	      dataSrc : function(json) {
		      $.each(json, function(key, item) {
			      item.arrive_date = $.fn.date_renderer(item.arrive_date);
			      item.confirmed_date = $.fn.date_renderer(item.confirmed_date);
		      })
		      return json;
	      },
	    },
	    columns : [ {
	      data : null,
	      defaultContent : '',
	      width: "50px",
	      visible: false,
	      orderable : false,
	      className : 'select-checkbox',
	    }, {
	      data : 'row_no',
	      className : 'dt-center',
	      title : '行号',
	    }, {
	      data : 'inventory_name',
	      title : '存货名称',
	    }, {
	      data : 'inventory_code',
	      title : '存货代码',
	    }, {
	      data : 'unit_name',
	      className : 'dt-center',
	      title : '单位',
	    }, {
	      data : 'quantity',
	      className : 'dt-right',
	      title : '订单数量',
	    }, {
	      data : 'quantity',
	      className : 'dt-right',
	      title : '订单箱数',
	    }, {
	      data : 'arrived_quantity',
	      className : 'dt-right',
	      title : '订单已交数量',
	    }, {
	      data : 'arrived_quantity',
	      className : 'dt-right',
	      title : '订单已交箱数',
	    }, {
	      data : 'quantity',
	      className : 'dt-right',
	      title : '订单未交数量',
	    }, {
	      data : 'quantity',
	      className : 'dt-right',
	      title : '订单未交箱数',		 
	    }, {
	      data : null,
	      defaultContent: '',
	      className : 'dt-right',
	      title : '加急到货时间',
	    }, {
	      data : 'price',
	      className : 'dt-right',
	      title : '未税单价',
	    }, {
	      data : 'tax_price',
	      className : 'dt-right',
	      title : '含税单价',
	    }, {
	      data : 'money',
	      className : 'dt-right',
	      title : '未税金额',
	    }, {
	      data : 'sum',
	      className : 'dt-right',
	      title : '含税金额',
	    }, {
	      data : 'prepay_money',
	      className : 'dt-right',
	      title : '订金',
	    }, {
	      data : 'arrive_date',
	      title : '需求日期',
	      className : 'dt-center',
	      render : $.fn.date_renderer,
	    }, {
	      data : 'memo',
	      className : 'buyer-cell',
	      title : '备注',
	    }, {
	      data : 'confirmed_quantity',
	      className : 'dt-right',
	      title : '承诺交货数量',
	    }, {
	      data : 'confirmed_date',
	      title : '承诺交货日期',
	      className : 'dt-center vendor-cell',
	      render : $.fn.date_renderer,
	    }, {
	      data : 'confirmed_memo',
	      className : 'vendor-cell',
	      title : '供方备注',
	    } ],
	    footerCallback : function(row, data, start, end, display) {
		    App.footerCallback(this.api(), [ [ 14, "cost" ], [ 15, "cost" ] ]);
	    },
	  });

	  if (state == 1 && is_vendor) {
		  $('#basic_info').on('click', 'tbody td.vendor-cell', function(e) {
			  editor.inline(this, {
			    submit : 'allIfChanged',
			    submitOnBlur : true
			  });
		  });
	  }

	  function submit(state) {
		  editor.submit();
		  var data = basic_table.rows().data().toArray();
		  var small_data = [];
		  $.each(data, function(key, item) {
			  small_data.push({
			    id : item.id,
			    confirmed_date : item.confirmed_date,
			    confirmed_memo : item.confirmed_memo
			  });
		  });

		  $('#form').ajaxSubmit({
		    data : {
		      code : $('#code').val(),
		      state : state,
		      table : small_data
		    },
		    success : function(res, status, xhr, form) {
			    App.showSuccessDialog("操作成功", function() {
				    window.location.reload(true);
			    });
		    },
		    error : function(res, status, xhr, form) {
			    App.showErrorDialog("操作失败", "请输入正确的值");
		    }
		  });

	  }

	  $("#deploy").click(function() {
		  editor.submit();
		  submit(1);
	  });

	  $("#negotiate").click(function() {
		  editor.submit();
		  submit(2);		  
	  });
	  
	  $("#negotiate_ok").click(function() {
		  editor.submit();
		  submit(3);		  
	  });
	  
	  $("#negotiate_cancel").click(function() {
		  editor.submit();
		  submit(4);		  
	  });
	  
	  $("#confirm").click(function() {
		  editor.submit();
		  submit(5);
	  });
	  
	  $("#close").click(function() {
		  editor.submit();
		  submit(6);		  
	  });

  });
</script>