<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<body>
  <div class="container"  layout:fragment="content">  
      <ul class="breadcrumb">
        <li>
          <a th:href="@{/}"><i class="fa fa-dashboard"></i> 首页</a>
        </li>
        <li class="active">订单管理</li>
      </ul>

      <div class="search-content">
          <div class="search-cell width-10">
            <label for="code">订单号码：</label>
            <input type="text" id="code" class="form-control">
          </div>
          <div class="search-cell width-10" id="vendor_div">
            <label for="vendor">供应商编码/名称：</label>
            <input type="text" id="vendor" class="form-control">
          </div>
          <div class="search-cell width-10">
            <label for="start_date">发布日期: </label>
            <input type="text" id="start_date" value="" class="form-control datepicker" />
          </div>
          <div class="search-cell width-10">
            <label for="end_date">　</label>
            <input type="text" id="end_date" value="" class="form-control datepicker" />
          </div>
          <div class="search-cell width-10">
            <label for="state">状态:</label>
            <select name="status" id="state" class="form-control">
            </select>
          </div>
          <div style="vertical-align: bottom" class="search-cell width-15">
            <button class="btn btn-default" id="btn_search"><i class="fa fa-search"></i> 查询</button>
            <button class="btn btn-danger" sec:authorize="hasRole('ROLE_VENDOR')" id="btn_show_price"><i class="fa fa-eye"></i> 显示金额</button>
          </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
            <table id="example" class="table table-striped table-bordered nowrap table-striped table-hover" style="width:100%">
            </table>
        </div>
      </div>
      <div class="modal fade" id="pwd_dialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="password_title">二级密码认证</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <form id="pwdform" th:action="@{/profile/check_second_password}" method="post">
                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                          <label for="old_pwd">二级密码: </label>
                          <input type="password" id="pwd" name="pwd" class="form-control" />
                        </div>
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm_password">确认</button>
                </div>
            </div>
        </div>
    </div>
  </div>  
</body>
</html>

<script th:inline="javascript" sec:authorize="hasRole('ROLE_VENDOR')">
is_vendor = 1;
</script>

<script th:inline="javascript">
/*[+
var sync_url = [[@{/sync/purchaseorder/vendor}]];
var list_url = [[@{/purchaseorder/list}]];
var edit_url = [[@{/purchaseorder/}]];
+]*/ 

  $(document).ready(function() {
    if (is_vendor){
      $('#vendor_div').addClass('hidden');
    }
    $("#state").select2({
      data : App.getPurchaseOrderStateDataWithAll(),
      minimumResultsForSearch : -1,
    });
    
    if (!is_vendor)
    	  $("#state").val(0).trigger("change");
    
    $(".datepicker").datepicker({
      onSelect: function(dateText) {
        table.draw();
      }
    });

    var table = $('#example').DataTable({
      ordering : true,
      scrollY : '355px',
      ajax : {
        url : list_url,
        data : function(data) {
          var filter = {
            order : data.columns[data.order[0].column].data,
            dir : data.order[0].dir,
            rows_per_page : data.length,
            page_index : data.start / data.length + 1,
            vendor : $('#vendor').val(),
            state: $('#state').val(),
            code : $('#code').val(),
            start_date : $('#start_date').val(),
            end_date : $('#end_date').val()
          }
          return filter;
        },
        dataSrc : function(json) {
          json.recordsTotal = json.totalElements;
          json.recordsFiltered = json.totalElements;
          return json.content;
        },
      },
      createdRow: function( row, data, dataIndex ) {
          $(row).addClass('');
      },
	    fixedColumns: {
        leftColumns: 3,
    	},
      columns : [ {
        data : 'purchase_type_name',
        title : '订单类型'
      }, {
        data : 'code',
        title : '订单编号',
        render : function(data, display, record) {
          url = edit_url + data + '/edit';
          return '<a href="' + url + '">' + data + '</a>';
        },
      }, {
        data : 'orderdate',
        className: 'dt-center',
        title : '订单日期',
        render : $.fn.date_renderer
      }, {
        data : 'companyname',
        className: 'dt-center',
        title : '业务实体',
      }, {
        data : 'vendorname',
        visible: false,
        className: 'dt-center',
        title : '收货仓库',
      }, {
        data : 'vencode',
        visible: !is_vendor,
        className: 'dt-center',
        title : '供应商编码',
      }, {
        data : 'vendorname',
        visible: !is_vendor,
        title : '供应商简称'
      }, {
        data : 'tax_rate',
        className: 'dt-right',
        title : '税率'
      }, {
        data : 'currency',
        className: 'dt-right',
        title : '币种'
      }, {
        data : 'exchange_rate',
        className: 'dt-right',
        title : '汇率'
      }, {
        data : 'sum',
        className: 'dt-right',
        title : '原币金额',
        render: App.costNumber,
      }, {
        data : 'money',
        className: 'dt-right',
        title : '原币价税合计',
        render: App.costNumber,
      }, {
        data : 'prepay_money',
        className: 'dt-right',
        title : '订金',
        render: App.costNumber,
      }, {
        data : null,
        defaultContent: '',
        orderable: false,
        visible: false,
        className: 'dt-right',
        title : '购方备注'
      }, {
        data : 'department',
        className: 'dt-right',
        title : '采购组织'
      }, {
        data : 'person',
        className: 'dt-right',
        title : '采购员'
      }, {
        data : 'state',
        className: 'dt-center',
        title : 'ERP状态'
      }, {
        data : 'srmstate',
        title : 'SRM状态',
        className: 'dt-center',
        createdCell: App.getInqueryStateClass,
        render : App.getPurchaseOrderStateOfId
      }, {
        data : 'maker',
        className: 'dt-center',
        title : '制单人'
      }, {
        data : 'makedate',
        className: 'dt-center',
        render : $.fn.date_renderer,
        title : '制单日期'
      }, {
        data : 'verifier',
        className: 'dt-center',
        title : '审核人'
      }, {
        data : 'audittime',
        className: 'dt-center',
        render : $.fn.date_renderer,
        title : '审核日期'
      }, {
        data : 'deployername',
        className: 'dt-center',
        title : '发布人'
      }, {
        data : 'deploydate',
        className: 'dt-center',
        title : '发布日期',
        render : $.fn.date_renderer,
      }, {
        data : 'reviewername',
        className: 'dt-center',
        title : '确认人'
      }, {
        data : 'reviewdate',
        className: 'dt-center',
        title : '确认日期',
        render : $.fn.date_renderer,
      }, {
        data : 'closer',
        className: 'dt-center',
        title : '关闭人'
      }, {
        data : 'closedate',
        render : $.fn.date_renderer,
        className: 'dt-center',
        title : '关闭日期'
      } ],
      rowCallback: function (row, data) {
        if (data.srmstate == 3) {
            $(row).addClass('closed');
        }
    	},
      order: [  [ 2, "desc" ] ]      
    });

    $("#btn_search").click(function() {
      table.draw();
    });
    
    $('#state').change(function() {
      table.draw();
    });
    
    $('#vendor, #code, #start_date, #end_date').keyup(function(e) {
      if (e.keyCode == 13)
        table.draw();
    });
    
    $("#sync").click(function() {
      App.showConfirmDialog('确定要同步吗?', function() {
        $.ajax({
          beforeSend: function(){
            App.blockUI();
          },
          complete: function(){
            App.unblockUI();
          }, 
          url : sync_url,
          success : function(data, res) {
            if (data == true) {
              App.showSuccessDialog("同步成功");
            }else{
              App.showSuccessDialog("同步失败");
            }
          }
        });
      });
      
    });
    
    $("#pwdform").validate({
      rules: {
          pwd: {
            required: true
          },  
      },
      
      //display error alert on form submit  
      invalidHandler: function(event, validator) {
        App.showErrorDialog("输入有误", "请输入正确的值");
      },

      submitHandler: function (form) {
        jQuery(form).ajaxSubmit({
          beforeSend: function(){
            App.blockUI();
          },
          complete: function(){
            App.unblockUI();
          },
          success: function(res, status, xhr, form) {          	
            if (res == 1) {
            	$('#pwd_dialog').modal('hide');   
              App.showSuccessDialog("操作成功！");
              window.location.reload(true);
            }else{
              App.showErrorDialog("二级密码认证失败！");
            }
              
          },
          error: function (res, status, xhr, form) {
            App.showErrorDialog("操作失败", "请输入正确的值");
          }
        });
      }
    }); 
    
    $("#btn_show_price").click(function() {    	
    	$("#pwd").val("");    	
      $('#pwd_dialog').modal('show');          
    });
    
    $("#confirm_password").click(function() {
      $("#pwdform").submit();            
    });
  });
</script>